<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shooting Mayhem</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            user-select: none;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(to bottom, #6b2eb1, #8f90f0);
            font-family: 'Courier New', monospace;
            overflow: hidden;
            color: #fff;
            padding: 10px;
        }
        
        #game-wrapper {
            position: relative;
            max-width: 800px;
            width: 100%;
            background: #0c1d3d;
            border: 4px solid #b90404;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            overflow: hidden;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 aspect ratio */
        }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0c1d3d;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 14px;
            color: #ffcc00;
            text-shadow: 2px 2px 0 #000;
            z-index: 5;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            padding: 20px;
        }
        
        h1 {
            font-size: 32px;
            color: #ffcc00;
            text-shadow: 3px 3px 0 #f00;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .instructions {
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.5;
            max-width: 90%;
            font-size: 14px;
        }
        
        button {
            background: #ffcc00;
            color: #1a2a6c;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #cc9900;
        }
        
        button:hover {
            background: #ffdd33;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #cc9900;
        }
        
        button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #cc9900;
        }
        
        .stat {
            margin-bottom: 5px;
        }
        
        #health-bar {
            width: 120px;
            height: 12px;
            background: #444;
            border: 1px solid #fff;
            margin-top: 3px;
            border-radius: 3px;
            overflow: hidden;
        }
        
        #health-fill {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #ff0000, #ffcc00);
            transition: width 0.3s;
        }
        
        /* Mobile controls */
        #mobile-controls {
            position: absolute;
            bottom: 15px;
            left: 0;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 5;
        }
        
        .joystick-area {
            width: 100px;
            height: 100px;
            position: relative;
        }
        
        .joystick-background {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .joystick-handle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        
        .joystick-label {
            position: absolute;
            bottom: -22px;
            width: 100%;
            text-align: center;
            color: #ffcc00;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
            font-size: 12px;
        }
        
        /* Media query for mobile devices */
        @media (max-width: 768px) {
            #game-wrapper {
                max-width: 100%;
                height: auto;
            }
            
            #game-container {
                padding-top: 75vh;
            }
            
            #mobile-controls {
                display: flex;
            }
            
            h1 {
                font-size: 26px;
            }
            
            .instructions {
                font-size: 12px;
            }
            
            button {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            #ui {
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .joystick-area {
                width: 90px;
                height: 90px;
            }
            
            .joystick-handle {
                width: 35px;
                height: 35px;
            }
        }
        
        /* Media query for very small screens */
        @media (max-width: 350px) {
            .joystick-area {
                width: 80px;
                height: 80px;
            }
            
            .joystick-handle {
                width: 30px;
                height: 30px;
            }
            
            .joystick-label {
                font-size: 11px;
                bottom: -20px;
            }
        }
        
        .enemy-health-bar {
            position: absolute;
            width: 32px;
            height: 4px;
            background: #444;
            border: 1px solid #000;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .enemy-health-fill {
            height: 100%;
            background: linear-gradient(to right, #ff0000, #00ff00);
        }
        
        .critical-hit {
            position: absolute;
            color: #ffcc00;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
            animation: floatUp 1s forwards;
        }
        
        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-30px);
            }
        }
        
        #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 15;
            padding: 20px;
        }
        
        #restart-button {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <canvas id="game-canvas"></canvas>
            
            <div id="ui">
                <div class="stat">SCORE: <span id="score">0</span></div>
                <div class="stat">HEALTH: <span id="health">100</span></div>
                <div id="health-bar"><div id="health-fill"></div></div>
                <div class="stat">AMMO: <span id="ammo-count">6</span>/6</div>
                <div class="stat" id="powerup-timer">RIFLE: <span id="powerup-time">0</span>s</div>
                <div class="stat" id="powerup-cooldown">POWERUP CD: <span id="cooldown-time">0</span>s</div>
            </div>
            
            <div id="start-screen">
                <h1>SHOOTING MAYHEM</h1>
                <div class="instructions">
                    <p>Use WASD to move | Aim with mouse and CLICK to shoot | Press R to reload.</p>
                    <p>In mobile to move use the left joystick while on the right joystick is aim and shoot</p>
                    <br>
                    <p>Collect rare green orbs for a rifle power-up with 200 ammo for 20 seconds!</p>
                    <br>
                    <p>Critical hits deal extra damage! Enemies get stronger as your score increases!</p>
                    <br>
                    <p>Defeat as many enemies as you can without dying!</p>
                </div>
                <button id="start-button">START GAME</button>
            </div>
            
            <div id="game-over-screen">
                <h1>GAME OVER</h1>
                <div class="instructions">
                    <p>Your Score: <span id="final-score">0</span></p>
                    <p>Defeated Enemies: <span id="defeated-count">0</span></p>
                </div>
                <button id="restart-button">PLAY AGAIN</button>
            </div>
            
            <div id="mobile-controls">
                <div class="joystick-area" id="move-joystick">
                    <div class="joystick-background">
                        <div class="joystick-handle" id="move-handle"></div>
                    </div>
                    <div class="joystick-label">MOVE</div>
                </div>
                <div class="joystick-area" id="aim-joystick">
                    <div class="joystick-background">
                        <div class="joystick-handle" id="aim-handle"></div>
                    </div>
                    <div class="joystick-label">AIM & SHOOT</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game initialization
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const startButton = document.getElementById('start-button');
        const gameOverScreen = document.getElementById('game-over-screen');
        const restartButton = document.getElementById('restart-button');
        const scoreElement = document.getElementById('score');
        const healthElement = document.getElementById('health');
        const healthFill = document.getElementById('health-fill');
        const ammoElement = document.getElementById('ammo-count');
        const powerupTimer = document.getElementById('powerup-timer');
        const powerupTimeElement = document.getElementById('powerup-time');
        const powerupCooldown = document.getElementById('powerup-cooldown');
        const cooldownTimeElement = document.getElementById('cooldown-time');
        const finalScoreElement = document.getElementById('final-score');
        const defeatedCountElement = document.getElementById('defeated-count');
        const moveHandle = document.getElementById('move-handle');
        const aimHandle = document.getElementById('aim-handle');
        
        // Set canvas size
        function resizeCanvas() {
            const container = document.getElementById('game-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        // Game state
        let gameRunning = false;
        let score = 0;
        let playerHealth = 100;
        let ammo = 6;
        let reloading = false;
        let rifleActive = false;
        let rifleTimeLeft = 0;
        let powerupCooldownTime = 0;
        let isMobile = false;
        let criticalHits = [];
        let defeatedEnemies = 0;
        
        // Player properties
        const player = {
            x: 0,
            y: 0,
            width: 32,
            height: 32,
            speed: 5,
            color: '#3498db',
            direction: { x: 0, y: -1 } // Default direction (up)
        };
        
        // Power-up properties
        let powerups = [];
        
        // Bullets array
        let bullets = [];
        
        // Enemies array
        let enemies = [];
        
        // Particles array
        let particles = [];
        
        // Input handling
        const keys = {};
        let mouseX = 0;
        let mouseY = 0;
        
        // Mobile controls
        let moveJoystick = { x: 0, y: 0, active: false };
        let aimJoystick = { x: 0, y: 0, active: false };
        let lastShootTime = 0;
        let shootInterval = 200; // ms between shots for pistol
        const rifleShootInterval = 75; // ms between shots for rifle (much faster)
        
        // Check if on mobile device
        function checkMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }
        
        // Initialize game
        function init() {
            gameRunning = true;
            score = 0;
            playerHealth = 100;
            ammo = 6;
            reloading = false;
            rifleActive = false;
            rifleTimeLeft = 0;
            powerupCooldownTime = 0;
            defeatedEnemies = 0;
            bullets = [];
            enemies = [];
            particles = [];
            powerups = [];
            criticalHits = [];
            
            resizeCanvas();
            
            // Position player
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            
            isMobile = checkMobile();
            document.getElementById('mobile-controls').style.display = isMobile ? 'flex' : 'none';
            
            // Hide game over screen and show game UI
            gameOverScreen.style.display = 'none';
            
            updateScore();
            updateHealth();
            updateAmmo();
            updatePowerupTimer();
            updateCooldownTimer();
            
            // Spawn initial enemies
            for (let i = 0; i < 5; i++) {
                spawnEnemy();
            }
            
            // Start game loop
            gameLoop();
        }
        
        // Calculate enemy stats based on score
        function getEnemyStats() {
            const scoreFactor = Math.min(5, 1 + score / 500); // Cap at 5x stats
            return {
                speed: (1 + Math.random() * 2) * scoreFactor,
                health: Math.floor(3 * scoreFactor),
                damage: 0.5 * scoreFactor
            };
        }
        
        // Spawn a new enemy
        function spawnEnemy() {
            const side = Math.floor(Math.random() * 4);
            let x, y;
            
            switch(side) {
                case 0: // top
                    x = Math.random() * canvas.width;
                    y = -30;
                    break;
                case 1: // right
                    x = canvas.width + 30;
                    y = Math.random() * canvas.height;
                    break;
                case 2: // bottom
                    x = Math.random() * canvas.width;
                    y = canvas.height + 30;
                    break;
                case 3: // left
                    x = -30;
                    y = Math.random() * canvas.height;
                    break;
            }
            
            const stats = getEnemyStats();
            
            enemies.push({
                x: x,
                y: y,
                width: 32,
                height: 32,
                speed: stats.speed,
                color: '#e74c3c',
                health: stats.health,
                maxHealth: stats.health,
                damage: stats.damage
            });
        }
        
        // Spawn a power-up (20% chance for rifle)
        function spawnPowerup() {
            // Only spawn if cooldown is complete
            if (powerupCooldownTime > 0) return;
            
            const type = Math.random() < 0.2 ? 'rifle' : 'health';
            
            powerups.push({
                x: Math.random() * (canvas.width - 40) + 20,
                y: Math.random() * (canvas.height - 40) + 20,
                width: 20,
                height: 20,
                type: type
            });
            
            // Start cooldown (30 seconds)
            powerupCooldownTime = 30;
            powerupCooldown.style.display = 'block';
            updateCooldownTimer();
        }
        
        // Create particles
        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    size: 2 + Math.random() * 4,
                    color: color,
                    speedX: -2 + Math.random() * 4,
                    speedY: -2 + Math.random() * 4,
                    life: 20 + Math.random() * 20
                });
            }
        }
        
        // Create critical hit text
        function createCriticalHit(x, y) {
            criticalHits.push({
                x: x,
                y: y,
                life: 60,
                text: 'CRITICAL!'
            });
        }
        
        // Activate rifle power-up
        function activateRifle() {
            rifleActive = true;
            rifleTimeLeft = 20; // 20 seconds
            ammo = 200; // 200 ammo
            shootInterval = rifleShootInterval; // Faster firing rate
            updateAmmo();
            updatePowerupTimer();
            powerupTimer.style.display = 'block';
            
            // Create activation particles
            createParticles(player.x, player.y, '#00ff00', 30);
        }
        
        // Deactivate rifle power-up
        function deactivateRifle() {
            rifleActive = false;
            ammo = 6;
            shootInterval = 200; // Back to normal firing rate
            updateAmmo();
            powerupTimer.style.display = 'none';
            
            // Create deactivation particles
            createParticles(player.x, player.y, '#3498db', 20);
        }
        
        // Activate health power-up
        function activateHealth() {
            playerHealth = Math.min(100, playerHealth + 30);
            updateHealth();
            
            // Create health particles
            createParticles(player.x, player.y, '#ff0066', 20);
        }
        
        // Draw aiming guide
        function drawAimingGuide() {
            if (isMobile && aimJoystick.active || !isMobile) {
                const length = rifleActive ? 150 : 100; // Longer guide for rifle
                
                ctx.beginPath();
                ctx.moveTo(player.x, player.y);
                ctx.lineTo(
                    player.x + player.direction.x * length,
                    player.y + player.direction.y * length
                );
                
                // Different style for rifle
                if (rifleActive) {
                    ctx.strokeStyle = 'rgba(0, 255, 0, 0.6)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                } else {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([3, 3]);
                }
                
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
        
        // Update game state
        function update() {
            if (!gameRunning) return;
            
            // Update rifle timer
            if (rifleActive) {
                rifleTimeLeft -= 1/60; // Assuming 60 FPS
                updatePowerupTimer();
                
                if (rifleTimeLeft <= 0) {
                    deactivateRifle();
                }
            }
            
            // Update power-up cooldown
            if (powerupCooldownTime > 0) {
                powerupCooldownTime -= 1/60;
                updateCooldownTimer();
                
                if (powerupCooldownTime <= 0) {
                    powerupCooldown.style.display = 'none';
                }
            }
            
            // Update critical hits
            for (let i = criticalHits.length - 1; i >= 0; i--) {
                criticalHits[i].life--;
                if (criticalHits[i].life <= 0) {
                    criticalHits.splice(i, 1);
                }
            }
            
            // Move player based on input
            if (isMobile && moveJoystick.active) {
                player.x += moveJoystick.x * player.speed;
                player.y += moveJoystick.y * player.speed;
            } else {
                if (keys['w'] || keys['W']) {
                    player.y -= player.speed;
                }
                if (keys['s'] || keys['S']) {
                    player.y += player.speed;
                }
                if (keys['a'] || keys['A']) {
                    player.x -= player.speed;
                }
                if (keys['d'] || keys['D']) {
                    player.x += player.speed;
                }
            }
            
            // Keep player within bounds
            player.x = Math.max(player.width/2, Math.min(canvas.width - player.width/2, player.x));
            player.y = Math.max(player.height/2, Math.min(canvas.height - player.height/2, player.y));
            
            // Update player direction based on mouse position or aim joystick
            let dx, dy, dist;
            
            if (isMobile && aimJoystick.active) {
                dx = aimJoystick.x;
                dy = aimJoystick.y;
                dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > 0) {
                    player.direction.x = dx / dist;
                    player.direction.y = dy / dist;
                }
                
                // Auto-shoot on mobile when aiming
                const now = Date.now();
                if (now - lastShootTime > shootInterval) {
                    shoot();
                    lastShootTime = now;
                }
            } else {
                dx = mouseX - player.x;
                dy = mouseY - player.y;
                dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > 0) {
                    player.direction.x = dx / dist;
                    player.direction.y = dy / dist;
                }
            }
            
            // Update bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.speedX;
                bullet.y += bullet.speedY;
                
                // Remove bullets that are off-screen
                if (bullet.x < 0 || bullet.x > canvas.width || 
                    bullet.y < 0 || bullet.y > canvas.height) {
                    bullets.splice(i, 1);
                    continue;
                }
                
                // Check for collisions with enemies
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    const dx = bullet.x - enemy.x;
                    const dy = bullet.y - enemy.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < enemy.width/2) {
                        // Check for critical hit (15% chance)
                        const isCritical = Math.random() < 0.15;
                        const damage = isCritical ? 2 : 1;
                        
                        enemy.health -= damage;
                        
                        // Show critical hit text
                        if (isCritical) {
                            createCriticalHit(enemy.x, enemy.y);
                        }
                        
                        // Create hit particles
                        createParticles(enemy.x, enemy.y, isCritical ? '#ffcc00' : '#ff9900', isCritical ? 15 : 10);
                        
                        if (enemy.health <= 0) {
                            // Add score (extra for critical kills)
                            score += isCritical ? 15 : 10;
                            defeatedEnemies++;
                            updateScore();
                            
                            // Create death particles
                            createParticles(enemy.x, enemy.y, '#e74c3c', 20);
                            
                            // Remove enemy
                            enemies.splice(j, 1);
                            
                            // Spawn a new enemy
                            spawnEnemy();
                                            // Chance to spawn power-up (only if cooldown is complete)
                            if (powerupCooldownTime <= 0 && Math.random() < 0.1) {
                                spawnPowerup();
                            }
                        }
                        
                        // Remove bullet
                        bullets.splice(i, 1);
                        break;
                    }
                }
            }
            
            // Check for power-up collisions
            for (let i = powerups.length - 1; i >= 0; i--) {
                const powerup = powerups[i];
                const dx = player.x - powerup.x;
                const dy = player.y - powerup.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist < player.width/2 + powerup.width/2) {
                    if (powerup.type === 'rifle') {
                        activateRifle();
                    } else if (powerup.type === 'health') {
                        activateHealth();
                    }
                    
                    powerups.splice(i, 1);
                    
                    // Start cooldown
                    powerupCooldownTime = 30;
                    powerupCooldown.style.display = 'block';
                    updateCooldownTimer();
                }
            }
            
            // Update enemies
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                
                // Move towards player
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                enemy.x += (dx / dist) * enemy.speed;
                enemy.y += (dy / dist) * enemy.speed;
                
                // Check collision with player
                if (dist < player.width/2 + enemy.width/2) {
                    playerHealth -= enemy.damage;
                    updateHealth();
                    
                    // Create hit particles
                    createParticles(enemy.x, enemy.y, '#ffffff', 3);
                    
                    if (playerHealth <= 0) {
                        gameOver();
                    }
                }
                
                // Remove enemies that are too far away (for performance)
                if (dist > 2000) {
                    enemies.splice(i, 1);
                    spawnEnemy(); // Replace with a new enemy
                }
            }
            
            // Update particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.speedX;
                p.y += p.speedY;
                p.life--;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
            
            // Randomly spawn new enemies
            if (enemies.length < 5 + Math.floor(score / 100) && Math.random() < 0.02) {
                spawnEnemy();
            }
        }
        
        // Shoot function
        function shoot() {
            if (!gameRunning || reloading) return;
            
            if (ammo > 0) {
                // Create a new bullet
                bullets.push({
                    x: player.x + player.direction.x * 20,
                    y: player.y + player.direction.y * 20,
                    speedX: player.direction.x * 10,
                    speedY: player.direction.y * 10
                });
                
                // Create muzzle flash particles
                createParticles(
                    player.x + player.direction.x * 20, 
                    player.y + player.direction.y * 20, 
                    rifleActive ? '#00ff00' : '#ff9900', 
                    rifleActive ? 8 : 5
                );
                
                // Update ammo
                ammo--;
                updateAmmo();
                
                // Check if need to reload (only if not using rifle)
                if (ammo === 0 && !rifleActive) {
                    reload();
                }
            }
        }
        
        // Draw everything
        function draw() {
            // Clear canvas
            ctx.fillStyle = '#0c1d3d';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid background for pixel effect
            ctx.strokeStyle = 'rgba(50, 80, 150, 0.2)';
            ctx.lineWidth = 1;
            
            for (let x = 0; x < canvas.width; x += 20) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < canvas.height; y += 20) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Draw aiming guide
            drawAimingGuide();
            
            // Draw particles
            for (const p of particles) {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
            }
            
            // Draw power-ups
            for (const powerup of powerups) {
                if (powerup.type === 'rifle') {
                    // Draw green orb
                    ctx.fillStyle = '#00ff00';
                    ctx.beginPath();
                    ctx.arc(powerup.x, powerup.y, powerup.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw glow effect
                    ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
                    ctx.beginPath();
                    ctx.arc(powerup.x, powerup.y, powerup.width/2 + 3, 0, Math.PI * 2);
                    ctx.fill();
                } else if (powerup.type === 'health') {
                    // Draw health orb (pink)
                    ctx.fillStyle = '#ff0066';
                    ctx.beginPath();
                    ctx.arc(powerup.x, powerup.y, powerup.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw glow effect
                    ctx.fillStyle = 'rgba(255, 0, 102, 0.3)';
                    ctx.beginPath();
                    ctx.arc(powerup.x, powerup.y, powerup.width/2 + 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Draw enemies with health bars
            for (const enemy of enemies) {
                // Draw enemy shadow
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(enemy.x - enemy.width/2 + 3, enemy.y - enemy.height/2 + 3, enemy.width, enemy.height);
                
                // Draw enemy body
                ctx.fillStyle = enemy.color;
                ctx.fillRect(enemy.x - enemy.width/2, enemy.y - enemy.height/2, enemy.width, enemy.height);
                
                // Draw enemy eyes
                ctx.fillStyle = '#000';
                ctx.fillRect(enemy.x - 6, enemy.y - 6, 4, 4);
                ctx.fillRect(enemy.x + 2, enemy.y - 6, 4, 4);
                
                // Draw enemy health bar
                const healthWidth = 32;
                const healthHeight = 4;
                const healthX = enemy.x - healthWidth/2;
                const healthY = enemy.y - enemy.height/2 - 8;
                
                // Health bar background
                ctx.fillStyle = '#333';
                ctx.fillRect(healthX, healthY, healthWidth, healthHeight);
                
                // Health bar fill
                const healthPercent = enemy.health / enemy.maxHealth;
                ctx.fillStyle = healthPercent > 0.5 ? '#00ff00' : healthPercent > 0.25 ? '#ffff00' : '#ff0000';
                ctx.fillRect(healthX, healthY, healthWidth * healthPercent, healthHeight);
            }
            
            // Draw bullets
            for (const bullet of bullets) {
                ctx.fillStyle = rifleActive ? '#00ff00' : '#ffcc00';
                ctx.fillRect(bullet.x - 2, bullet.y - 2, 4, 4);
                
                // Draw bullet trail for rifle
                if (rifleActive) {
                    ctx.beginPath();
                    ctx.moveTo(bullet.x - bullet.speedX, bullet.y - bullet.speedY);
                    ctx.lineTo(bullet.x, bullet.y);
                    ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
            
            // Draw critical hit text
            for (const crit of criticalHits) {
                const alpha = crit.life / 60;
                ctx.fillStyle = `rgba(255, 204, 0, ${alpha})`;
                ctx.font = 'bold 12px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText(crit.text, crit.x, crit.y - crit.life/2);
            }
            
            // Draw player shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            ctx.fillRect(player.x - player.width/2 + 3, player.y - player.height/2 + 3, player.width, player.height);
            
            // Draw player
            ctx.fillStyle = rifleActive ? '#00ff00' : player.color;
            ctx.fillRect(player.x - player.width/2, player.y - player.height/2, player.width, player.height);
            
            // Draw player details
            ctx.fillStyle = '#000';
            ctx.fillRect(player.x - 6, player.y - 6, 4, 4);
            ctx.fillRect(player.x + 2, player.y - 6, 4, 4);
            
            // Draw weapon
            ctx.fillStyle = rifleActive ? '#00aa00' : '#444';
            // Weapon handle
            ctx.fillRect(
                player.x + player.direction.x * 10 - 4, 
                player.y + player.direction.y * 10 - 4, 
                8, 8
            );
            // Weapon barrel
            ctx.fillRect(
                player.x + player.direction.x * 15 - 2, 
                player.y + player.direction.y * 15 - 2, 
                player.direction.x * (rifleActive ? 25 : 20), 
                player.direction.y * (rifleActive ? 25 : 20)
            );
        }
        
        // Game loop
        function gameLoop() {
            if (!gameRunning) return;
            
            update();
            draw();
            
            requestAnimationFrame(gameLoop);
        }
        
        // Handle mouse click for shooting
        canvas.addEventListener('click', function() {
            if (!isMobile) {
                shoot();
            }
        });
        
        // Reload function
        function reload() {
            if (reloading) return;
            
            reloading = true;
            setTimeout(() => {
                ammo = 6;
                updateAmmo();
                reloading = false;
            }, 1000);
        }
        
        // Keyboard input handling
        window.addEventListener('keydown', function(e) {
            keys[e.key] = true;
            
            // Reload with R key
            if ((e.key === 'r' || e.key === 'R') && gameRunning && !reloading && !rifleActive) {
                reload();
            }
        });
        
        window.addEventListener('keyup', function(e) {
            keys[e.key] = false;
        });
        
        // Mouse movement handling
        canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
        });
        
        // Simple and reliable joystick implementation
        function setupJoystick(joystickId, joystickData, handleElement) {
            const joystick = document.getElementById(joystickId);
            const handle = handleElement;
            const maxDistance = 30; // Maximum distance the handle can move
            
            let touchId = null;
            
            joystick.addEventListener('touchstart', function(e) {
                e.preventDefault();
                if (touchId === null) {
                    const touch = e.changedTouches[0];
                    touchId = touch.identifier;
                    joystickData.active = true;
                    updateJoystick(touch.clientX, touch.clientY);
                }
            });
            
            window.addEventListener('touchmove', function(e) {
                if (touchId === null) return;
                
                for (let i = 0; i < e.changedTouches.length; i++) {
                    const touch = e.changedTouches[i];
                    if (touch.identifier === touchId) {
                        e.preventDefault();
                        updateJoystick(touch.clientX, touch.clientY);
                        break;
                    }
                }
            });
            
            window.addEventListener('touchend', function(e) {
                if (touchId === null) return;
                
                for (let i = 0; i < e.changedTouches.length; i++) {
                    const touch = e.changedTouches[i];
                    if (touch.identifier === touchId) {
                        resetJoystick();
                        break;
                    }
                }
            });
            
            window.addEventListener('touchcancel', function(e) {
                if (touchId === null) return;
                
                for (let i = 0; i < e.changedTouches.length; i++) {
                    const touch = e.changedTouches[i];
                    if (touch.identifier === touchId) {
                        resetJoystick();
                        break;
                    }
                }
            });
            
            function updateJoystick(touchX, touchY) {
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                let x = touchX - centerX;
                let y = touchY - centerY;
                
                // Calculate distance from center
                const distance = Math.min(maxDistance, Math.sqrt(x * x + y * y));
                const angle = Math.atan2(y, x);
                
                // Calculate new position
                x = Math.cos(angle) * distance;
                y = Math.sin(angle) * distance;
                
                // Update handle position
                handle.style.transform = `translate(${x}px, ${y}px)`;
                
                // Normalize values between -1 and 1
                joystickData.x = x / maxDistance;
                joystickData.y = y / maxDistance;
            }
            
            function resetJoystick() {
                joystickData.active = false;
                joystickData.x = 0;
                joystickData.y = 0;
                handle.style.transform = 'translate(0, 0)';
                touchId = null;
            }
        }
        
        // Set up mobile controls
        setupJoystick('move-joystick', moveJoystick, moveHandle);
        setupJoystick('aim-joystick', aimJoystick, aimHandle);
        
        // Update score display
        function updateScore() {
            scoreElement.textContent = score;
        }
        
        // Update health display
        function updateHealth() {
            const health = Math.max(0, Math.floor(playerHealth));
            healthElement.textContent = health;
            healthFill.style.width = health + '%';
        }
        
        // Update ammo display
        function updateAmmo() {
            ammoElement.textContent = ammo;
        }
        
        // Update power-up timer display
        function updatePowerupTimer() {
            powerupTimeElement.textContent = Math.max(0, Math.floor(rifleTimeLeft));
        }
        
        // Update cooldown timer display
        function updateCooldownTimer() {
            cooldownTimeElement.textContent = Math.max(0, Math.floor(powerupCooldownTime));
        }
        
        // Game over
        function gameOver() {
            gameRunning = false;
            
            // Update final score and defeated enemies count
            finalScoreElement.textContent = score;
            defeatedCountElement.textContent = defeatedEnemies;
            
            // Show game over screen
            gameOverScreen.style.display = 'flex';
        }
        
        // Start game on button click
        startButton.addEventListener('click', function() {
            startScreen.style.display = 'none';
            init();
        });
        
        // Restart game on button click
        restartButton.addEventListener('click', function() {
            gameOverScreen.style.display = 'none';
            init();
        });
        
        // Initialize game on load
        window.addEventListener('load', function() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        });
    </script>
</body>
</html>